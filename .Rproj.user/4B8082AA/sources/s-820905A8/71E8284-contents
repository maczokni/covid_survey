library(haven)
library(questionr) # https://juba.github.io/questionr/reference/index.html
library(dplyr)

# read in data
data <- read_dta("https://www.dropbox.com/s/o8f52y7iy1pxrai/Covid-19_Police_Study_W2_longprep.dta?dl=1")
w1_data <- read_dta("https://www.dropbox.com/s/jpuaglzbd2oxl5y/Covid-19_Police_Study_W1_weights.dta?dl=1")
weights <- read_dta("https://www.dropbox.com/s/ezndmkwasce4j5o/Covid-19_Police_Study_W2_weights.dta?dl=1")
w1_weights <- read_dta("https://www.dropbox.com/s/nclnjf5uly3jrl8/Covid-19_Police_Study_W1.dta?dl=1")

w1_data %>% group_by(covidcompliance_1) %>% count() %>% mutate(perc = round(n / sum(.$n)*100,0))

w1_data <- left_join(w1_data, w1_weights %>% 
                    mutate(wt = weight) %>% # pick which weight to use 
                    select(prolificid, wt), by = c("prolificid" = "prolificid")) %>% 
  select(covidcompliance_1, wt) %>% 
  mutate_at(vars(-wt),as_factor)
# ‘socialised in person with friends or relatives whom you don’t live with?’ (86% said never, 10% said rarely, 2% said sometimes and 2% said often or very often),


data <- left_join(data, weights %>% 
               mutate(wt = weight) %>% # pick which weight to use 
              select(prolificid, wt), by = c("prolificid" = "prolificid")) %>% 
  select(b_foc, b_focfr, b_focqol, b_focwo, b_prec, 
         b_prectyp_1, b_prectyp_6, b_prectyp_7, b_prectyp_8, 
         b_prectyp_10, b_prectyp_11, b_prectypo, b_precqof, b_precs, wt) %>% 
  mutate_at(vars(-wt),as_factor)

df <- as.data.frame(wtd.table(data2$b_foc, weights = data2$wt))

df %>% mutate(perc = round(Freq/sum(Freq)*100, 0))

#count with weights
data2 %>% group_by(b_foc) %>% count(wt = wt) %>% mutate(perc = round(n / sum(.$n)*100,0))
#count without weights
data2 %>% group_by(b_foc) %>% count() %>% mutate(perc = round(n / sum(.$n)*100,0))
#when we include weights it just sums up the wt column
data2 %>% group_by(b_foc) %>% summarise(n = sum(wt, na.rm = T)) %>% mutate(perc = round(n / sum(.$n)*100,0))



data %>% 
  group_by(b_foc) %>% 
  count()

data %>% 
  group_by(b_focfr) %>% 
  count()

data %>% 
  group_by(b_focwo) %>% 
  count()

data %>% 
  group_by(b_focqol) %>% 
  count()

data %>% 
  group_by(b_prec) %>% 
  count()

data %>% 
  group_by(b_foc, b_prec) %>% 
  count()

other_precs <- data %>% select(b_prectypo)  %>% 
  filter(!is.na(b_prectypo),
         nchar(b_prectypo) > 0) 

# write.csv(other_precs, "other_precautions.csv")

data %>% 
  group_by(b_precs) %>% 
  count()

data %>% 
  group_by(as_factor(b_precqof)) %>% 
  count()
  
View(data %>% 
  group_by(b_precqof, b_precs) %>% 
  count())


data %>% 
  mutate(b_focqol_bi = ifelse(b_focqol), b_focwo, b_prec, 
           b_prectyp_1, b_prectyp_6, b_prectyp_7, b_prectyp_8, 
           b_prectyp_10, b_prectyp_11, b_prectypo, b_precqof, b_precs) %>% 
  summarise()



data2 <- data %>% 
  select(b_foc, b_focqol, b_focwo, b_prec, b_prectyp_1, b_prectyp_6, b_prectyp_7, 
         b_prectyp_8, b_prectyp_10, b_prectyp_11, b_precqof, b_precs) %>% 
  mutate_all(as_factor) %>% 
  mutate(fearcovid = case_when(
          # Unworried
          b_foc=="No" ~ "Unworried", # not worried
          # Functional
          b_foc=="Yes" & # worried about catching covid in past 3 weeks
          b_focqol %in% c("Not at all", "A little") &  #  quality of life is not reduced by worry
          b_prec=="Yes" & # take precautions against catching covid
          b_precqof %in% c("Not at all", "A little") & #  quality of life is not reduced by precaution
          b_precs %in% c("Moderately","Quite a bit","Very much") ~ "Functional", #prec make them feel safer
          #Dysfunctional
          b_foc=="Yes" & # worried about covid
            b_focqol %in% c("Moderately","Quite a bit","Very much") & #quality of life affected by worry
            b_prec=="No" | #doesn't take precaution
          # OR
          b_foc=="Yes" & #worried about covid
            b_focqol %in% c("Moderately","Quite a bit","Very much") &   #quality of life affected by worry
            b_prec=="Yes" & #takes precautions
            b_precs %in% c("Not at all", "A little") | #precautions don't work
          # OR
          b_foc=="Yes" & #worried about covid
            b_focqol %in% c("Moderately","Quite a bit","Very much") &   #quality of life affected by worry
            b_prec=="Yes" & #takes precautions
            b_precqof %in% c("Moderately","Quite a bit","Very much") ~"Dysfunctional", # precautions affect QoL
          TRUE ~"???"),   #everyone else 
    fearcovid_reka = case_when(
            # Unworried
            b_foc=="No" ~ "Unworried", # not worried
            # Functional
            b_foc=="Yes" & # worried about catching covid in past 3 weeks
              b_focqol %in% c("Not at all", "A little") &  #  quality of life is not reduced by worry
              b_prec=="No" | # doesn't take precautions agaist covid
              #OR
              b_foc=="Yes" & # worried about catching covid in past 3 weeks
              b_focqol %in% c("Not at all", "A little") &  #  quality of life is not reduced by worry
              b_prec=="Yes" & # take precautions against catching covid
              b_precqof %in% c("Not at all", "A little") & #  quality of life is not reduced by precaution
              b_precs %in% c("Moderately","Quite a bit","Very much") ~ "Functional", #prec make them feel safer
            #Dysfunctional
            b_foc=="Yes" & # worried about covid
              b_focqol %in% c("Moderately","Quite a bit","Very much") & #quality of life affected by worry
              b_prec=="No" | #doesn't take precaution
              # OR
              b_foc=="Yes" & #worried about covid
              b_focqol %in% c("Moderately","Quite a bit","Very much") &   #quality of life affected by worry
              b_prec=="Yes" & #takes precautions
              b_precs %in% c("Not at all", "A little") | #precautions don't work
              # OR
              b_foc=="Yes" & #worried about covid
              b_focqol %in% c("Moderately","Quite a bit","Very much") &   #quality of life affected by worry
              b_prec=="Yes" & #takes precautions
              b_precqof %in% c("Moderately","Quite a bit","Very much") ~"Dysfunctional", # precautions affect QoL
            TRUE ~"???") 
    )
  

data2 %>% group_by(fearcovid) %>% count()
data2 %>% group_by(fearcovid_reka) %>% count()


data %>% 
  filter(fearcovid_reka == "???") %>% 
  group_by(b_foc, b_focqol, b_prec, b_precqof, b_precs) %>% 
  count() %>% View()



data %>% filter(
  grepl("wash", tolower(b_prectypo)) & grepl("hand", tolower(b_prectypo)))

# 0=unworried
# 1=’functional fear’, i.e. worried about catching covid in past 3 weeks, take precautions against catching covid that make them feel safer (psychologists talk about worry often being a motivational force, stimulating people to problem-solve) and quality of life is not reduced by worry or precaution
# 2=’dysfunctional fear’, i.e. worried about catching covid in past 3 weeks and quality of life reduced by either worry or precautions
# 
# Syntax (stata):
#   gen fearcovid=2
# replace fearcovid=0 if b_foc==2
# replace fearcovid=1 if b_foc==1 & b_focqol<7 & b_prec==1 & b_precqof<7 & b_precs>6
# tab fearcovid

# fearcovid |      Freq.     Percent        Cum.
# ------------+-----------------------------------
#   0 |        401       36.55       36.55
# 1 |        166       15.13       51.69
# 2 |        530       48.31      100.00
# ------------+-----------------------------------
#   Total |      1,097      100.00






  
  